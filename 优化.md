
## ä»»åŠ¡

1. æ‰“å°æ‰€æœ‰è¡Œæ•°
2. ç¬¬8åˆ—åŒ…å«åå­—ï¼Œ æ‰“å° 432 å’Œ 43243 ä¸ªåå­—
3. ç¬¬5åˆ—åŒ…å«æ—¥æœŸï¼Œè®¡ç®—æ¯æœˆä¸€å…±æœ‰å¤šå°‘ææ¬¾
4. è¿˜æ˜¯ç¬¬8åˆ—ï¼ŒæŠ½å–å‡ºåå­—ï¼Œè®¡ç®—å‡ºæœ€å¸¸è§çš„åå­—ï¼ˆfirst nameï¼‰ï¼Œä»¥åŠä¸€å…±å‡ºç°çš„æ¬¡æ•°

## Revision 0  åŸºç¡€ç‰ˆæœ¬

```
firstNamePat := regexp.MustCompile(", \\s*([^, ]+)")
names := make([]string, 0)
firstNames := make([]string, 0)
dates := make([]string, 0)
commonName := ""
commonCount := 0
```

scan æ–‡ä»¶

```go
31	for scanner.Scan() {
32		text := scanner.Text()
33
34		// get all the names
35		split := strings.SplitN(text, "|", 9) // 10.95
36		name := strings.TrimSpace(split[7])
37		names = append(names, name)
38
39		// extract first names
40		if matches := firstNamePat.FindAllStringSubmatch(name, 1); len(matches) > 0 {
41			firstNames = append(firstNames, matches[0][1])
42		}
43
44		// extract dates
45		chars := strings.TrimSpace(split[4])[:6]
46		date := chars[:4] + "-" + chars[4:6]
47		dates = append(dates, date)
48	}
```

æ±‚è§£ä»»åŠ¡

```go
50	// report c2: names at index
51	fmt.Printf("Name: %s at index: %v\n", names[0], 0)
52	fmt.Printf("Name: %s at index: %v\n", names[432], 432)
53	fmt.Printf("Name: %s at index: %v\n", names[43243], 43243)
54	fmt.Printf("Name time: %v\n", time.Since(start))
55
56	// report c1: total number of lines
57	fmt.Printf("Total file line count: %v\n", len(names))
58	fmt.Printf("Line count time: : %v\n", time.Since(start))
59
60	// report c3: donation frequency
61	dateMap := make(map[string]int)
62	for _, date := range dates {
63		dateMap[date] += 1
64	}
65	for k, v := range dateMap {
66		fmt.Printf("Donations per month and year: %v and donation count: %v\n", k, v)
67	}
68	fmt.Printf("Donations time: : %v\n", time.Since(start))
69
70	// report c4: most common firstName
71	nameMap := make(map[string]int)
72	ncount := 0 // new count
73	for _, name := range firstNames {
74		ncount = nameMap[name] + 1
75		nameMap[name] = ncount
76		if ncount > commonCount {
77			commonName = name
78			commonCount = ncount
79		}
80	}
81
82	fmt.Printf("The most common first name is: %s and it occurs: %v times.\n", commonName, commonCount)
83	fmt.Printf("Most common name time: %v\n", time.Since(start))
```



è¿™ä¸ªç‰ˆæœ¬ 33ç§’

## Revision 1  æ— è„‘goroutine ç‰ˆæœ¬ğŸ˜¢

ç®€å•çš„æƒ³æ³•ï¼š

- ä»ä¸‰ä¸ªé€šé“å¼€å§‹ä¸€ä¸ª goroutine è¯»å–`nameC, lastnameC, datesC`ä»¥è¿½åŠ åˆ—è¡¨
- å¯¹äºæ¯ä¸€è¡Œï¼Œä¸ºæ¯ä¸€è¡Œå¯åŠ¨ä¸€ä¸ª goroutine å¹¶è§£æ 3 ä¸ªå­—æ®µä»¥å°†å®ƒä»¬å‘é€åˆ°è¿™ä¸‰ä¸ªé€šé“ä¹‹ä¸€
- ç­‰å¾…æ‰€æœ‰ goroutine å®Œæˆ
- æ ¹æ®æŒ‘æˆ˜è§„åˆ™æŠ¥å‘Šï¼ˆc1-c4ï¼‰



æ¯ä¸€è¡Œç”Ÿæˆä¸€ä¸ª goroutineï¼Œè§£æå¡åˆ°ç»“æœchannelé‡Œé¢å»

```go
for scanner.Scan() {
		text := scanner.Text()
		wg.Add(3)
		go func() {
			// get all the names
			split := strings.SplitN(text, "|", 9)
			name := strings.TrimSpace(split[7])
			namesC <- name

			// extract first names
			if matches := firstNamePat.FindAllStringSubmatch(name, 1); len(matches) > 0 {
				firstNamesC <- matches[0][1]
			} else {
				wg.Add(-1)
			}

			// extract dates
			chars := strings.TrimSpace(split[4])[:6]
			date := chars[:4] + "-" + chars[4:6]
			datesC <- date
		}()
	}
```

ç„¶åæœ‰ä¸€ä¸ªä¸­çš„ï¼Œselectè¯»å–æ±‡æ€»ï¼Œå¡åˆ°ç»“æœlisté‡Œé¢å»

```go
go func() {
		for {
			select {
			case n, ok := <-namesC:
				if ok {
					names = append(names, n)
					wg.Done()
				}
			case fn, ok := <-firstNamesC:
				if ok {
					firstNames = append(firstNames, fn)
					wg.Done()
				}
			case d, ok := <-datesC:
				if ok {
					dates = append(dates, d)
					wg.Done()
				}
			}
		}
	}()
```





```
CPU-0: [read line1][read line2][read line3]
CPU-1:             [process line1]         [process line3]
CPU-2:                         [process line2]
```



```
send name      -> [ nameC      ] --\ 
send firstName -> [ firstNameC ] --- -> select() one -> [ append one to a list ]
send date      -> [ datesC     ] --/ 
```


12åˆ†é’Ÿ  732ç§’

1. æ€§èƒ½å·®çš„åŸå› ï¼Œæ¯è¡Œä¸€ä¸ª goroutineï¼Œè¿™ä¸ªoverheadå¤ªå¤§äº†ã€‚è€Œä¸”æ¶ˆæ¯ä¼ é€’å¤ªå¤šäº†ï¼Œå¼€äº†3ä¸ªchanï¼Œ3x18 million = 54 million messagesåœ¨ä¼ é€’ ã€‚

2. ç¬¬äºŒä¸ªé—®é¢˜ã€‚é€šé“ï¼Œè‡³å°‘æ˜¯å®¹é‡ä¸º 1 çš„éç¼“å†²é€šé“ï¼Œåœ¨å‘å®ƒä»¬å‘é€æ¶ˆæ¯æ—¶ä¼šé˜»å¡ã€‚Channel[è¢«é˜»å¡ï¼Œ](https://golang.org/ref/spec#Channel_types)ç›´åˆ°å®ƒçš„æ¥æ”¶ç«¯è¯»å–æ¶ˆæ¯ã€‚sending goroutines éœ€è¦ç­‰å¾…ï¼Œå› ä¸º *for - select*  å¤„ç†çš„goroutineæœ‰ç«äº‰ã€‚

è¿™è¾¹ä½œè€…ä½¿ç”¨äº†æä¸ª 1Mè¡Œçš„å°æ ·æœ¬è¿›è¡Œæµ‹è¯•ï¼Œä¸‹é¢æœ‰ä¸€å †åˆ†ægoroutineçš„ï¼Œå¾…è¿›ä¸€æ­¥å­¦ä¹ ã€‚

æˆ‘ä»¬åœ¨è¿™äº› Tracer æ—¥å¿—ä¸­çœ‹åˆ°çš„æ˜¯ä¸¤ä¸ª goroutineï¼Œä¸€ä¸ªè¯»å–è¡Œå¹¶å¯åŠ¨ goroutineï¼Œä¸€ä¸ªæ¥æ”¶æ¶ˆæ¯ï¼Œç„¶åæ˜¯ä¸€ç™¾ä¸‡è¡Œè§£æ goroutineï¼Œæ¯å½“å®ƒä»¬å‘é€šé“å‘é€æ¶ˆæ¯æ—¶ï¼Œè¿™äº› goroutine å°±ä¼šè¢«åˆ†æˆä¸‰éƒ¨åˆ†ã€‚å½“æˆ‘ä»¬åœ¨è·Ÿè¸ªå¼€å§‹æ—¶é€‰æ‹© ~120 æ¯«ç§’ä¹‹ä¸€æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„æ­£æ˜¯è¿™ä¸€ç‚¹ã€‚goroutine G1 å‘å‡ºç³»ç»Ÿè°ƒç”¨ä»¥è¯»å–æ–‡ä»¶ï¼Œç„¶åå¯åŠ¨è¡Œå¤„ç† goroutineã€‚ç„¶åæ˜¯ä¸€ä¸ªåä¸º G6 çš„ goroutineï¼Œå®ƒä»£è¡¨ for-select å¾ªç¯ï¼Œä»è¿™äº›é€šé“ä¹‹ä¸€ä¸­æ’å‡ºæ¶ˆæ¯å¹¶å°†æ•°æ®é™„åŠ åˆ°åˆ—è¡¨ä¹‹ä¸€ã€‚

ä»è·Ÿè¸ªæ—¥å¿—çš„ä¸­é—´æˆ–æœ«å°¾æŒ‘é€‰ä¸€ä¸ªè·Ÿè¸ªå™¨æ®µï¼Œæˆ‘ä»¬çœ‹åˆ°æ–‡ä»¶è¯»å– goroutine ä¸å†è¿è¡Œï¼ŒG6 åªæ˜¯åœ¨é‚£é‡ŒæŒ‘é€‰ä»»ä½•ç­‰å¾…æ¥æ”¶æ¶ˆæ¯çš„ gorutinesï¼ˆG6 åœ¨ ä¸­ç­‰å¾…[`runtime.selectgo()`](https://github.com/golang/go/blob/release-branch.go1.12/src/runtime/select.go#L105)ï¼‰ã€‚æ‰€æœ‰ CPU å†…æ ¸éƒ½é¥±å’Œäº†ï¼Œä¸»è¦æ˜¯ç­‰å¾…ä»è¿™äº›ç­‰å¾…ä¸­çš„ goroutine è·å–æ¶ˆæ¯ã€‚ç„¶åæ€»ç»“ä¸ºæˆ‘ä»¬æµ‹é‡çš„ 12 åˆ†é’Ÿã€‚ï¼ˆæœ‰å…³ Tracer çš„æ›´è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚é˜…[é™„å½• B4](https://marcellanz.com/post/file-read-challenge/#b4-gc-tracer-in-detail)ï¼‰

å¹¶ä¸”é€šé“å¿…é¡»ç­‰å¾…å…¶æ¥æ”¶ç«¯è¯»å–æ¶ˆæ¯ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥å‘ç°å¤§å¤šæ•°æ—¶å€™ goroutine è¢«æ‹†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ã€‚å½“æˆ‘ä»¬å°†æ¶ˆæ¯ä½œä¸ºå¹¶å‘è¿è¡Œçš„ goroutine å‘é€åˆ°ä¸‰ä¸ªé€šé“ä¹‹ä¸€æ—¶ï¼Œå®ƒä»¬ä¼šåˆ†è£‚ï¼Œå› ä¸º Go æ­£åœ¨è°ƒåº¦ goroutine åœ¨å¾ˆå¯èƒ½ä¸€ä¸ª goroutine å°†ç­‰å¾…è€Œå¦ä¸€ä¸ª goroutine å¯èƒ½è¢«è°ƒåº¦è¿è¡Œçš„ç‚¹ã€‚



##  Revision 2 â€“ å‡å°‘Channels ï¼Œå‡å°‘goroutine â­â­â­â­â­

å‡å°‘channelï¼Œä¸è¦æ¯ç§å…³å¿ƒçš„æ•°æ®å°±æä¸€ä¸ªchannelã€‚ æä¸€ä¸ªæ–°çš„structï¼ŒæŠŠæ•°æ®æåˆåœ¨ä¸€èµ·é€åˆ°channelé‡Œã€‚

```go
type entry struct {
		firstName string
		name      string
		date      string
		wg        *sync.WaitGroup
	}
```

æ¯64kä¸€ä¸ªgoroutine

```go
func main() {
    wg := sync.WaitGroup{}
    
    linesChunkLen := 64 * 1024
    lines := make([]string, 0, 0)
    
    for scanner.Scan() {
        line := scanner.Text()
        lines = append(lines, line)

        // lines è¿™é‡Œåˆ°äº† 64k
        //ä¸è¿‡è¿™è¾¹ä½œè€…å®ç°æœ‰ä¸ªbug ï¼Œæ°¸è¿œåªå¤„ç†äº† 64k * n å€æ•°çš„è¡Œæ•°ã€‚å‰©ä¸‹çš„æ²¡å¤„ç†
        if len(lines) == linesChunkLen {

            //WaitGroup å¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæœ€åˆä»0å¼€å§‹ï¼Œå®ƒæœ‰ä¸‰ä¸ªæ–¹æ³•ï¼šAdd(),
            //Done(), Wait() ç”¨æ¥æ§åˆ¶è®¡æ•°å™¨çš„æ•°é‡ã€‚Add(n) æŠŠè®¡æ•°å™¨è®¾ç½®ä¸ºn ï¼Œ
            //Done() æ¯æ¬¡æŠŠè®¡æ•°å™¨-1 ï¼Œwait() ä¼šé˜»å¡ä»£ç çš„è¿è¡Œï¼Œç›´åˆ°è®¡æ•°å™¨åœ°å€¼å‡
            //ä¸º0ã€‚
            wg.Add(len(lines))

            process := lines
            go func() {
                for _, text := range process {
                    // process here !
                    
                    entries <- e
                }
            }()
            lines = make([]string, 0, linesChunkLen)
        }
    }
    wg.Wait()
}

```



èŠ±è´¹ 18.285ç§’

## Revision 3 â€“ å‡å°‘channelé€šä¿¡â­â­â­â­

æ–¹æ¡ˆ2 æ€»å…±éœ€è¦å¾€chané‡Œé¢å‘é€18Mæ•°æ® ï¼Œ**ä¸è¿‡å¤„ç†18Mçš„æ•°æ®ä¹Ÿå¤ªå¤šäº†**ï¼Œå†æ¬¡ä¼˜åŒ–ï¼Œæ¯64kå‘é€ä¸€å—æ•°æ®è¿›è¡Œå¤„ç†ã€‚

å¯ä»¥è¿›ä¸€æ­¥å‡å°‘chan é€šä¿¡çš„å¼€é”€ï¼Œå¯¹äºæ¯ 64k è¡Œå—ï¼Œæˆ‘ä»¬å°†ç›¸åŒæ•°é‡çš„æ¡ç›®æ”¶é›†åˆ°ä¸€ä¸ªåˆ‡ç‰‡ä¸­ï¼Œå¹¶é€šè¿‡æ¡ç›®é€šé“å‘é€å®ƒä»¬`entriesC`ã€‚

```go
	linesChunkLen := 64 * 1024
	lines := make([]string, 0, 0)
	scanner.Scan()
	for {
		lines = append(lines, scanner.Text())
		willScan := scanner.Scan()
		if len(lines) == linesChunkLen || !willScan {
			toProcess := lines
			wg.Add(len(toProcess))
			go func() {
				entries := make([]entry, 0, len(toProcess))
				for _, text := range toProcess {
					//process here
					entries = append(entries, entry)
				}
                
                //è¿™æ ·å°±æ˜¯æ¯64kä¸€ä¸ªentry
				entriesC <- entries
			}()
			lines = make([]string, 0, linesChunkLen)
		}
		if !willScan {
			break
		}
	}
```

é€šè¿‡è¿™ä¸ªè®¡åˆ’ï¼Œæˆ‘ä»¬ä»ç‰ˆæœ¬ 0 ä¸­å‡å°‘äº† 60%æ—¶é—´ã€‚

æˆ‘ä»¬åˆä¸‹é™äº† 8 ç§’æˆ– -42%

10.66832747s

## Revision 4 â€“ Hang in on a Mutex ï¼ˆä¸ä¸€å®šæœ‰ç”¨ï¼‰ğŸ˜¢

æˆ‘ä»¬ä»ç„¶å°†è§£æè¡Œçš„å—æ„å»ºä¸ºæ¡ç›®ï¼Œä½†æˆ‘ä»¬ä¸ä¼šé€šè¿‡é€šé“å…±äº«å®ƒä»¬ä»¥å°†å®ƒä»¬é™„åŠ åˆ°æˆ‘ä»¬çš„ä¸‰ä¸ªåˆ—è¡¨ä¸­ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†é™„åŠ åˆ°å¾ªç¯ä¸­çš„åˆ—è¡¨å†…è”å¹¶ä½¿ç”¨[`sync.Mutex`](https://golang.org/pkg/sync/#Mutex). è¿™é‡Œæˆ‘ä»¬åˆ é™¤äº†ä¸€ä¸ªèµ„æºäº‰ç”¨å®ä¾‹ã€‚æˆ‘ä»¬æ²¡æœ‰é€šè¿‡é€šé“å‘é€æ¡ç›®å—å¹¶åœ¨å¦ä¸€ç«¯ç”±æ”¶é›† goroutine å¤„ç†ï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨ç­‰å¾…ï¼Œ`mutex.Lock()`ç›´åˆ°æˆ‘ä»¬å¯ä»¥è¿›å…¥ä»£ç éƒ¨åˆ†å°†è§£æçš„æ¡ç›®é™„åŠ åˆ°ä¸‰ä¸ªåˆ—è¡¨ä¸­ã€‚

æ­£å¦‚æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸€ä¸ªæ¸ é“æ¥åˆ†äº«æˆ‘ä»¬çš„æ•°æ®æ¥æœ€ç»ˆè¢«æ”¶é›†ã€‚æˆ‘ä»¬çš„ goroutine å¯ä»¥ä½¿ç”¨å®ƒæ”¶é›†çš„æ•°æ®åœ¨äº’æ–¥é”ä¸Šç­‰å¾…ï¼Œç›´åˆ°äº’æ–¥é”ç©ºé—²ã€‚ç„¶å goroutine åªæ˜¯åœåœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°å®ƒè¢«å®‰æ’ç»§ç»­ã€‚Go å·²ä¸º[`sync/mutex.go`](https://github.com/golang/go/blob/release-branch.go1.12/src/sync/mutex.go#L44). æˆ‘ä»¬çš„å¤„ç† goroutine ç­‰å¾…ç›´åˆ°å®ƒå¯ä»¥å°†è§£æçš„æ•°æ®é™„åŠ åˆ°è¿™äº›åˆ—è¡¨æœ¬èº«ï¼Œè€Œä¸æ˜¯ç­‰å¾…åœ¨é€šé“ä¸Šæ’å‡ºæ•°æ®ç„¶åé™„åŠ åˆ°åˆ—è¡¨ä¸­ã€‚



CPU å†…æ ¸ä»ç„¶å¾—åˆ°å¾ˆå¥½çš„ä½¿ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€æ¬¡è¿è¡Œ 6 ä¸ª goroutineã€‚åœ¨æ­¤ä¿®è®¢ç‰ˆä¸­ï¼Œæ˜¾å¼é€šé“çš„ä»£ç ç»„åˆç»“æ„æ¶ˆå¤±äº†ã€‚æˆ‘ä»¬æ²¡æœ‰è·å¾—å¤ªå¤šï¼Œä½†æˆ‘ä»¬æš‚æ—¶ä¿ç•™æ­¤ä¿®è®¢æ›´æ”¹ã€‚



10.31209465s



## Revision 5 â€“ Inside the Loopï¼ˆæœ‰ç”¨ï¼Œä½†ç»“æ„ä¸Šæœªå¿…åˆé€‚ï¼‰â­



åœ¨è¿™é‡Œï¼Œåœ¨æèµ æ—¶é—´å’Œå¸¸ç”¨åç§°æ—¶é—´ä¹‹é—´ï¼Œæˆ‘ä»¬éœ€è¦å¤§çº¦ 2 ç§’çš„æ—¶é—´æ¥*éå†*firstNames åˆ‡ç‰‡å¹¶æ‰¾åˆ°æœ€å¸¸ç”¨çš„åç§°ã€‚è®©æˆ‘ä»¬å°è¯•å°†å®ƒä»¬ï¼Œæèµ é¢‘ç‡è¡¨å’Œå…¬å…±åç§°è®¡æ•°å¸¦å…¥æˆ‘ä»¬çš„è§£æå¾ªç¯ã€‚å› æ­¤ï¼Œåœ¨æˆ‘ä»¬å°†è¡Œè§£æä¸ºæ¡ç›®åï¼Œå½“é™„åŠ åˆ°åˆ—è¡¨æ—¶ï¼Œæˆ‘ä»¬æ›´æ–°å¾ªç¯å†…çš„æ—¥æœŸé¢‘ç‡å’Œå¸¸ç”¨åç§°è®¡æ•°`Lines 68-81`ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¸å¿…éå†è¿™ä¸¤ä¸ªæ˜ å°„ï¼Œè¿™æ ·æˆ‘ä»¬åº”è¯¥ä¼šè·å¾—ä¸€äº›ç§’æ•°ã€‚

è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿæˆ‘æ€€ç–‘æˆ‘ä»¬å°†è§£æçš„æ•°æ®é™„åŠ åˆ°æˆ‘ä»¬çš„åˆ—è¡¨çš„ä»£ç éƒ¨åˆ†ï¼Œå¹¶æ²¡æœ‰å®Œå…¨é¥±å’Œè¿è¡Œæ­¤ä»£ç éƒ¨åˆ†çš„æ—¶é—´ï¼Œä¸å…¶ä»–åœ°æ–¹å‘ç”Ÿçš„ä¸€åˆ‡æœ‰å…³ã€‚æˆ‘ä»¬æ²¡æœ‰åœ¨è§£æè¿‡ç¨‹ä¸­æµªè´¹è¿™ä¸ªæ—¶é—´ï¼Œç„¶åè¿ç»­èŠ±æ—¶é—´å¾ªç¯æ˜ å°„å¹¶è®¡ç®—é¢‘ç‡è¡¨å’Œæœ€å¸¸è§çš„åç§°ï¼Œè€Œæ˜¯å°†è¿™æ®µä»£ç æ”¾åœ¨å¾ªç¯ä¸­ã€‚

> äººä»¬å¯èƒ½ä¼šå¼€å§‹è€ƒè™‘æˆ‘ä»¬åœ¨ä¿®è®¢ç‰ˆ 5 ä¸­æ‰€åšçš„ä¸å¯èƒ½çš„æœªæ¥éœ€æ±‚çš„æ‰©å±•ç¨‹åº¦ã€‚åœ¨æœªæ¥çš„æŒ‘æˆ˜ä¸­æˆ–éšç€éœ€æ±‚çš„å˜åŒ–ï¼Œå°†è¿™æ®µä»£ç æ”¾å…¥å¾ªç¯ä¸­å¯èƒ½ä¼šå¯¹å®ƒçš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚ä¸€ä¸ªåˆç†çš„ç‚¹ã€‚ä½†æˆ‘ä»¬åœ¨è¿™é‡Œä¹Ÿæ˜¯*ä¸ºäº†è¡¨ç°*ï¼Œå½“è°ˆåˆ°é‡åŒ–è¡¨ç°æ—¶ï¼Œè¿™äº›æ•°å­—ä¸ä¼šæ’’è°ã€‚å°±*ä»£ç è´¨é‡*è€Œè¨€ï¼Œæˆ‘å¹¶ä¸æ˜¯è¯´æˆ‘åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ”¯æŒè¿™ä¸€ç‚¹ï¼Œä½†æˆ‘ä»¬åœ¨è¿™é‡Œä»ç„¶æœ‰ä¸€äº›ä¹è¶£ï¼Œå¯¹å§ï¼Ÿ




## Revision 6 â€“ Reuse Allocated Memoryï¼ˆä¸ä¸€å®šæœ‰ç”¨ï¼‰ğŸ˜¢

åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ†é…è¡Œåˆ‡ç‰‡å’Œæ¡ç›®åˆ‡ç‰‡ï¼Œç„¶åæˆ‘ä»¬æ”¶é›†æ•°æ®è¡Œå’Œè§£æå­—æ®µçš„æ¡ç›®ã€‚ä¸€éåˆä¸€éåœ°åˆ†é…è¿™äº› 64k å¤§å°çš„åˆ‡ç‰‡å¯èƒ½ä¼šå¯¹æˆ‘ä»¬çš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ï¼Œå¯¹å§ï¼Ÿæœ‰äº† a`sync.Pool`æˆ‘ä»¬å¯ä»¥é‡ç”¨åˆ†é…çš„åˆ‡ç‰‡ï¼Œå¹¶ä¸”ä¸éœ€è¦é‡æ–°åˆ†é…ã€‚é™¤äº†åˆ‡ç‰‡æœ¬èº«çš„åˆ†é…ä¹‹å¤–ï¼Œæ¯å½“æˆ‘ä»¬å°†ä¸€ä¸ªå…ƒç´ é™„åŠ åˆ°ä¸€ä¸ªå®¹é‡ä¸è¶³çš„åˆ‡ç‰‡æ—¶ï¼ŒGo ä¼šå°†è¿™äº›åˆ‡ç‰‡[å¢é•¿](https://go.googlesource.com/go/+/refs/tags/go1.12.1/src/runtime/slice.go#76)2ï¼Œå®¹é‡å°äº 1024 å’Œ 1.25 ä»¥ä¸Š

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åˆ†é…äº†èµ·å§‹å®¹é‡ä¸º 0`linesChunkLen`çš„ line -slices å’Œ entry-slicesã€‚å°†å®ƒä»¬åˆ†é…åˆ°æˆ‘ä»¬åœ¨å¤„ç† 64k è¡Œå—æœŸé—´è‚¯å®šä¼šå¢é•¿çš„å¤§å°å¯èƒ½æ˜¯æœ‰ç›Šçš„



å‡å°‘äº†å†…å­˜ï¼Œæ—¶é—´å‡å°‘å’Œä¼˜åŒ–5ç›¸æ¯”ä¸å¤§ã€‚




## Revision 7: Regexp Usageâ­

æ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–

```
non-capturing groups
```

ä½¿ç”¨regexp.FindString() æ›¿æ¢ firstNamePat.FindAllStringSubmatch

8.155115627s

## Revision 8: No Regexpâ­

ä¸è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›´æ¥ä½¿ç”¨string åˆ†å‰²ï¼Œå–var[0]

6.644675587s

## Revision 9 â€“ Reduce the Garbageâ­â­â­

å‡å°‘åƒåœ¾å›æ”¶

```
names := make([]string, 0)
firstNames := make([]string, 0)
dates := make([]string, 0)
```

è¿™äº›å˜é‡éƒ½ä¸è¦å­˜ã€‚ å­˜æ—¥æœŸä¸è¦ä½¿ç”¨stringï¼Œä¼˜åŒ–æ ¼å¼ã€‚

3.880034076s

## å®é™…æµ‹è¯•

0  Most common name time: 34.047600994s
1  Most common name time: 2m12.035417704s
**2  Most common name time: 24.20121778s**
**3  Most common name time: 10.822801266s**
4  Most common name time: 10.990392216s
**5  Most common name time: 7.682424486s**
6  Most common name time: 7.601689327s
7  Most common name time: 8.237632763s
8  Most common name time: 7.393345424s
**9  Most common name time: 4.620049996s**



ç¬¬äºŒæ¬¡

Most common name time: 33.94785455s
Most common name time: 2m9.82728601s
**Most common name time: 24.817026451s**
**Most common name time: 9.999810015s**
Most common name time: 11.112604532s
Most common name time: 8.041027428s
Most common name time: 7.770875019s
Most common name time: 7.61388109s
Most common name time: 8.046549356s
**Most common name time: 4.573964724s**



## è¡¥å……

1. å¦‚ä½•åˆ¤æ–­ä¼˜åŒ–å·²ç»åˆ°è¾¾æé™ï¼Ÿ 

ä¸parseï¼Œå…‰è¯»å–ä¸€éæ–‡ä»¶ï¼Œä¹Ÿéœ€è¦3.56s

2. æ›´è¿›ä¸€æ­¥

ä½¿ç”¨ scanner.Bytes() æ›¿æ¢ scanner.Text() ï¼Œå…‰è¯»å–ä¸€éå¯ä»¥ä¸‹é™åˆ°2.392783786s

3. æ ¸æ•°çš„å½±å“

GOMAXPROCS=1 go run ./rev9/readfile9.go itcont.txt
GOMAXPROCS=2 go run ./rev9/readfile9.go itcont.txt
GOMAXPROCS=4 go run ./rev9/readfile9.go itcont.txt

è¿›è¡Œæµ‹è¯•

